<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Visualizer - AI Agent Â∑•‰ΩúÊµÅÁ®ãÂèØËßÜÂåñ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --border-color: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --success: #22c55e;
            --warning: #eab308;
            --error: #ef4444;
            --waiting: #6b7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* È°∂ÈÉ®ÊéßÂà∂Ê†è */
        .control-bar {
            height: 60px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .control-bar h1 {
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        /* ‰∏ªÂ∏ÉÂ±Ä */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Â∑¶‰æß Agent ÂàóË°® */
        .agent-list {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 16px;
            overflow-y: auto;
        }

        .agent-list h2 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .agent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }

        .agent-item:hover {
            background: var(--bg-tertiary);
        }

        .agent-item.active {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .agent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-weight: 500;
            font-size: 14px;
        }

        .agent-role {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .agent-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-running { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-waiting { background: var(--warning); }
        .status-completed { background: var(--waiting); }
        .status-failed { background: var(--error); }

        /* ‰∏≠Èó¥ÂèØËßÜÂåñÂå∫Âüü */
        .visualization {
            flex: 1;
            position: relative;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .visualization canvas {
            width: 100%;
            height: 100%;
        }

        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Âè≥‰æßËØ¶ÊÉÖÈù¢Êùø */
        .details-panel {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            padding: 16px;
            overflow-y: auto;
        }

        .details-panel.collapsed {
            width: 0;
            padding: 0;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .panel-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h3 {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .detail-value {
            font-size: 13px;
            font-weight: 500;
        }

        .message-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .message-item {
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .message-from {
            color: var(--accent);
            font-weight: 500;
        }

        .message-to {
            color: var(--success);
        }

        .message-time {
            color: var(--text-secondary);
        }

        .message-content {
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        /* Êó∂Èó¥Á∫ø */
        .timeline {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .timeline-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .timeline-btn:hover {
            background: var(--accent);
        }

        .timeline-progress {
            width: 200px;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            cursor: pointer;
        }

        .timeline-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #ec4899);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s;
        }

        .timeline-time {
            font-size: 13px;
            color: var(--text-secondary);
            min-width: 80px;
        }

        /* Ê∑ªÂä† Agent ÊåâÈíÆ */
        .add-agent-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .add-agent-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Âä®Áîª */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes flow {
            0% { stroke-dashoffset: 20; }
            100% { stroke-dashoffset: 0; }
        }

        .flowing {
            stroke-dasharray: 10, 10;
            animation: flow 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- È°∂ÈÉ®ÊéßÂà∂Ê†è -->
    <header class="control-bar">
        <h1>ü§ñ Agent Visualizer</h1>
        <div class="controls">
            <button class="btn btn-secondary" onclick="exportPNG()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                ÂØºÂá∫ PNG
            </button>
            <button class="btn btn-secondary" onclick="exportJSON()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                ÂØºÂá∫ JSON
            </button>
        </div>
    </header>

    <div class="main-container">
        <!-- Â∑¶‰æß Agent ÂàóË°® -->
        <aside class="agent-list">
            <h2>Agent ÂàóË°®</h2>
            <div id="agentList"></div>
            <button class="add-agent-btn" onclick="addNewAgent()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:8px">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Ê∑ªÂä† Agent
            </button>
        </aside>

        <!-- ‰∏≠Èó¥ÂèØËßÜÂåñÂå∫Âüü -->
        <main class="visualization" id="visualization">
            <svg id="flowCanvas" width="100%" height="100%">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#8b5cf6"/>
                    </marker>
                    <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <g id="connections"></g>
                <g id="nodes"></g>
            </svg>
            <div class="empty-state" id="emptyState">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="3"/>
                    <circle cx="4" cy="6" r="2"/>
                    <circle cx="20" cy="6" r="2"/>
                    <circle cx="4" cy="18" r="2"/>
                    <circle cx="20" cy="18" r="2"/>
                    <line x1="6" y1="6" x2="9" y2="10"/>
                    <line x1="18" y1="6" x2="15" y2="10"/>
                    <line x1="6" y1="18" x2="9" y2="14"/>
                    <line x1="18" y1="18" x2="15" y2="14"/>
                </svg>
                <p>ÁÇπÂáª"Ê∑ªÂä† Agent"ÂºÄÂßãÂàõÂª∫Â∑•‰ΩúÊµÅÁ®ã</p>
            </div>
            <!-- Êó∂Èó¥Á∫ø -->
            <div class="timeline">
                <button class="timeline-btn" onclick="skipToStart()" title="Ë∑≥Âà∞ÂºÄÂßã">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="19 20 9 12 19 4 19 20"/>
                        <line x1="5" y1="19" x2="5" y2="5" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
                <button class="timeline-btn" onclick="stepBackward()" title="‰∏ä‰∏ÄÊ≠•">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="11 19 2 12 11 5 11 19"/>
                        <polygon points="22 19 13 12 22 5 22 19"/>
                    </svg>
                </button>
                <button class="timeline-btn" id="playBtn" onclick="togglePlay()" title="Êí≠Êîæ/ÊöÇÂÅú">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" id="playIcon">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                </button>
                <button class="timeline-btn" onclick="stepForward()" title="‰∏ã‰∏ÄÊ≠•">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="13 19 22 12 13 5 13 19"/>
                        <polygon points="2 19 11 12 2 5 2 19"/>
                    </svg>
                </button>
                <button class="timeline-btn" onclick="skipToEnd()" title="Ë∑≥Âà∞ÁªìÊùü">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="5 4 15 12 5 20 5 4"/>
                        <line x1="19" y1="5" x2="19" y2="19" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
                <div class="timeline-progress" onclick="seekTimeline(event)">
                    <div class="timeline-progress-bar" id="progressBar"></div>
                </div>
                <span class="timeline-time" id="timelineTime">0:00 / 0:00</span>
            </div>
        </main>

        <!-- Âè≥‰æßËØ¶ÊÉÖÈù¢Êùø -->
        <aside class="details-panel" id="detailsPanel">
            <div class="panel-header">
                <h2>ËØ¶ÁªÜ‰ø°ÊÅØ</h2>
                <button class="close-btn" onclick="closeDetails()">√ó</button>
            </div>
            <div id="panelContent">
                <p style="color: var(--text-secondary); text-align: center; padding: 40px 0;">
                    ÈÄâÊã©‰∏Ä‰∏™ Agent Êü•ÁúãËØ¶ÊÉÖ
                </p>
            </div>
        </aside>
    </div>

    <script>
        // Agent Êï∞ÊçÆ
        let agents = [];
        let messages = [];
        let selectedAgent = null;
        let isPlaying = false;
        let currentTime = 0;
        let animationId = null;

        // Agent ËßíËâ≤ÈÖçÁΩÆ
        const agentRoles = {
            'CEO': { icon: 'üëî', color: '#8b5cf6', role: 'ÂÜ≥Á≠ñËÄÖ' },
            'CTO': { icon: 'üíª', color: '#3b82f6', role: 'ÊäÄÊúØ‰∏ªÁÆ°' },
            'Researcher': { icon: 'üîç', color: '#10b981', role: 'Á†îÁ©∂Âëò' },
            'Designer': { icon: 'üé®', color: '#ec4899', role: 'ËÆæËÆ°Â∏à' },
            'Developer': { icon: '‚ö°', color: '#f59e0b', role: 'ÂºÄÂèëËÄÖ' },
            'QA': { icon: 'üß™', color: '#06b6d4', role: 'ÊµãËØïÂ∑•Á®ãÂ∏à' },
            'Marketing': { icon: 'üì¢', color: '#ef4444', role: 'Â∏ÇÂú∫ÊÄªÁõë' },
            'Sales': { icon: 'üí∞', color: '#84cc16', role: 'ÈîÄÂîÆÊÄªÁõë' }
        };

        // ÂàùÂßãÂåñÁ§∫‰æãÊï∞ÊçÆ
        function initDemo() {
            agents = [
                { id: 1, name: 'Bezos', role: 'CEO', status: 'running', x: 400, y: 300 },
                { id: 2, name: 'Vogels', role: 'CTO', status: 'waiting', x: 200, y: 150 },
                { id: 3, name: 'Thompson', role: 'Researcher', status: 'completed', x: 200, y: 450 },
                { id: 4, name: 'Duarte', role: 'Designer', status: 'waiting', x: 600, y: 150 },
                { id: 5, name: 'Bach', role: 'QA', status: 'waiting', x: 600, y: 450 }
            ];

            messages = [
                { from: 1, to: 2, content: 'ÂàÜÊûêÊñ∞È°πÁõÆÊäÄÊúØÊñπÊ°à', time: '10:00' },
                { from: 1, to: 3, content: 'Ë∞ÉÁ†îÂ∏ÇÂú∫ËßÑÊ®°', time: '10:05' },
                { from: 2, to: 4, content: 'ÈúÄË¶ÅUIËÆæËÆ°Á®ø', time: '10:15' },
                { from: 3, to: 1, content: 'Â∏ÇÂú∫ËßÑÊ®°Ë∞ÉÁ†îÂÆåÊàê', time: '10:30' },
                { from: 4, to: 1, content: 'ËÆæËÆ°Á®øÂ∑≤ÂÆåÊàê', time: '10:45' },
                { from: 1, to: 5, content: 'ÂáÜÂ§áÊµãËØïËÆ°Âàí', time: '11:00' }
            ];

            renderAgents();
            renderFlow();
            updateTimeline();
        }

        // Ê∏≤Êüì Agent ÂàóË°®
        function renderAgents() {
            const list = document.getElementById('agentList');
            list.innerHTML = agents.map(agent => `
                <div class="agent-item ${selectedAgent === agent.id ? 'active' : ''}" onclick="selectAgent(${agent.id})">
                    <div class="agent-avatar" style="background: ${agentRoles[agent.role]?.color || '#6b7280'}20; color: ${agentRoles[agent.role]?.color || '#6b7280'}">
                        ${agentRoles[agent.role]?.icon || 'ü§ñ'}
                    </div>
                    <div class="agent-info">
                        <div class="agent-name">${agent.name}</div>
                        <div class="agent-role">${agentRoles[agent.role]?.role || agent.role}</div>
                    </div>
                    <div class="agent-status status-${agent.status}"></div>
                </div>
            `).join('');
        }

        // Ê∏≤ÊüìÊµÅÁ®ãÂõæ
        function renderFlow() {
            const nodesGroup = document.getElementById('nodes');
            const connectionsGroup = document.getElementById('connections');
            const emptyState = document.getElementById('emptyState');

            if (agents.length === 0) {
                emptyState.style.display = 'block';
                nodesGroup.innerHTML = '';
                connectionsGroup.innerHTML = '';
                return;
            }

            emptyState.style.display = 'none';

            // ÁªòÂà∂ËøûÁ∫ø
            connectionsGroup.innerHTML = messages.map((msg, idx) => {
                const fromAgent = agents.find(a => a.id === msg.from);
                const toAgent = agents.find(a => a.id === msg.to);
                if (!fromAgent || !toAgent) return '';

                return `
                    <line
                        x1="${fromAgent.x}" y1="${fromAgent.y}"
                        x2="${toAgent.x}" y2="${toAgent.y}"
                        stroke="url(#lineGradient)"
                        stroke-width="2"
                        marker-end="url(#arrowhead)"
                        class="flowing"
                        style="animation-delay: ${idx * 0.5}s"
                    />
                `;
            }).join('');

            // ÁªòÂà∂ËäÇÁÇπ
            nodesGroup.innerHTML = agents.map(agent => {
                const role = agentRoles[agent.role] || { color: '#6b7280', icon: 'ü§ñ' };
                return `
                    <g class="agent-node" onclick="selectAgent(${agent.id})" style="cursor: pointer">
                        <circle
                            cx="${agent.x}" cy="${agent.y}" r="35"
                            fill="${role.color}20"
                            stroke="${role.color}"
                            stroke-width="2"
                        />
                        <text x="${agent.x}" y="${agent.y - 5}" text-anchor="middle" fill="${role.color}" font-size="20">
                            ${role.icon}
                        </text>
                        <text x="${agent.x}" y="${agent.y + 18}" text-anchor="middle" fill="#f1f5f9" font-size="12" font-weight="500">
                            ${agent.name}
                        </text>
                        <circle
                            cx="${agent.x + 25}" cy="${agent.y - 25}" r="8"
                            fill="${getStatusColor(agent.status)}"
                            stroke="#1e293b"
                            stroke-width="2"
                        />
                    </g>
                `;
            }).join('');
        }

        function getStatusColor(status) {
            const colors = {
                'running': '#22c55e',
                'waiting': '#eab308',
                'completed': '#6b7280',
                'failed': '#ef4444'
            };
            return colors[status] || '#6b7280';
        }

        // ÈÄâÊã© Agent
        function selectAgent(id) {
            selectedAgent = id;
            renderAgents();
            renderDetails();
        }

        // Ê∏≤ÊüìËØ¶ÊÉÖÈù¢Êùø
        function renderDetails() {
            const panel = document.getElementById('panelContent');
            const agent = agents.find(a => a.id === selectedAgent);

            if (!agent) {
                panel.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 40px 0;">
                        ÈÄâÊã©‰∏Ä‰∏™ Agent Êü•ÁúãËØ¶ÊÉÖ
                    </p>
                `;
                return;
            }

            const role = agentRoles[agent.role] || { role: agent.role };
            const agentMessages = messages.filter(m => m.from === agent.id || m.to === agent.id);

            panel.innerHTML = `
                <div class="detail-section">
                    <h3>Âü∫Êú¨‰ø°ÊÅØ</h3>
                    <div class="detail-item">
                        <span class="detail-label">ÂêçÁß∞</span>
                        <span class="detail-value">${agent.name}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ËßíËâ≤</span>
                        <span class="detail-value">${role.role}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Áä∂ÊÄÅ</span>
                        <span class="detail-value" style="color: ${getStatusColor(agent.status)}">
                            ${getStatusText(agent.status)}
                        </span>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Ê∂àÊÅØÂéÜÂè≤ (${agentMessages.length})</h3>
                    <div class="message-list">
                        ${agentMessages.map(msg => {
                            const fromAgent = agents.find(a => a.id === msg.from);
                            const toAgent = agents.find(a => a.id === msg.to);
                            return `
                                <div class="message-item">
                                    <div class="message-header">
                                        <span>
                                            <span class="message-from">${fromAgent?.name || 'Êú™Áü•'}</span>
                                            ‚Üí
                                            <span class="message-to">${toAgent?.name || 'Êú™Áü•'}</span>
                                        </span>
                                        <span class="message-time">${msg.time}</span>
                                    </div>
                                    <div class="message-content">${msg.content}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function getStatusText(status) {
            const texts = {
                'running': 'ËøêË°å‰∏≠',
                'waiting': 'Á≠âÂæÖ‰∏≠',
                'completed': 'Â∑≤ÂÆåÊàê',
                'failed': 'Â§±Ë¥•'
            };
            return texts[status] || status;
        }

        // ÂÖ≥Èó≠ËØ¶ÊÉÖÈù¢Êùø
        function closeDetails() {
            document.getElementById('detailsPanel').classList.add('collapsed');
        }

        // Ê∑ªÂä†Êñ∞ Agent
        function addNewAgent() {
            const roles = Object.keys(agentRoles);
            const newId = Math.max(...agents.map(a => a.id), 0) + 1;
            const newRole = roles[Math.floor(Math.random() * roles.length)];
            const newAgent = {
                id: newId,
                name: `Agent ${newId}`,
                role: newRole,
                status: 'waiting',
                x: 200 + Math.random() * 400,
                y: 100 + Math.random() * 400
            };
            agents.push(newAgent);
            renderAgents();
            renderFlow();
            selectAgent(newId);
        }

        // Êó∂Èó¥Á∫øÊéßÂà∂
        function togglePlay() {
            isPlaying = !isPlaying;
            document.getElementById('playIcon').innerHTML = isPlaying
                ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>'
                : '<polygon points="5 3 19 12 5 21 5 3"/>';

            if (isPlaying) {
                animate();
            } else {
                cancelAnimationFrame(animationId);
            }
        }

        function animate() {
            if (!isPlaying) return;
            currentTime += 0.1;
            if (currentTime >= messages.length) {
                currentTime = 0;
            }
            updateTimeline();
            animationId = requestAnimationFrame(animate);
        }

        function updateTimeline() {
            const progress = (currentTime / Math.max(messages.length, 1)) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;

            const currentM = Math.floor(currentTime);
            const totalM = messages.length;
            document.getElementById('timelineTime').textContent = `${currentM}:${Math.floor((currentTime % 1) * 60).toString().padStart(2, '0')} / ${totalM}:00`;
        }

        function skipToStart() {
            currentTime = 0;
            updateTimeline();
        }

        function skipToEnd() {
            currentTime = Math.max(0, messages.length - 1);
            updateTimeline();
        }

        function stepForward() {
            currentTime = Math.min(currentTime + 1, messages.length - 1);
            updateTimeline();
        }

        function stepBackward() {
            currentTime = Math.max(currentTime - 1, 0);
            updateTimeline();
        }

        function seekTimeline(event) {
            const rect = event.target.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            currentTime = percent * Math.max(0, messages.length - 1);
            updateTimeline();
        }

        // ÂØºÂá∫ÂäüËÉΩ
        function exportPNG() {
            alert('ÂØºÂá∫ PNG ÂäüËÉΩÂºÄÂèë‰∏≠...');
        }

        function exportJSON() {
            const data = {
                agents: agents,
                messages: messages,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'agent-workflow.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ÂàùÂßãÂåñ
        initDemo();
    </script>
</body>
</html>
