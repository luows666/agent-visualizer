<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Visualizer - AI Agent Â∑•‰ΩúÊµÅÁ®ãÂèØËßÜÂåñ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --border-color: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --success: #22c55e;
            --warning: #eab308;
            --error: #ef4444;
            --waiting: #6b7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* È°∂ÈÉ®ÊéßÂà∂Ê†è */
        .control-bar {
            height: 60px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .control-bar h1 {
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* ‰∏ªÂ∏ÉÂ±Ä */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Â∑¶‰æß Agent ÂàóË°® */
        .agent-list {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 16px;
            overflow-y: auto;
        }

        .agent-list h2 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .agent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }

        .agent-item:hover {
            background: var(--bg-tertiary);
        }

        .agent-item.active {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .agent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-weight: 500;
            font-size: 14px;
        }

        .agent-role {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .agent-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-running { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-waiting { background: var(--warning); }
        .status-completed { background: var(--waiting); }
        .status-failed { background: var(--error); }

        /* ‰∏≠Èó¥ÂèØËßÜÂåñÂå∫Âüü */
        .visualization {
            flex: 1;
            position: relative;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .visualization canvas {
            width: 100%;
            height: 100%;
        }

        #threeCanvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        /* 3D ËßÜÂõæÊéßÂà∂ÊèêÁ§∫ */
        .view-hint {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .view-hint.show {
            opacity: 1;
        }

        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Âè≥‰æßËØ¶ÊÉÖÈù¢Êùø */
        .details-panel {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            padding: 16px;
            overflow-y: auto;
        }

        .details-panel.collapsed {
            width: 0;
            padding: 0;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .panel-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h3 {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .detail-value {
            font-size: 13px;
            font-weight: 500;
        }

        .message-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .message-item {
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .message-from {
            color: var(--accent);
            font-weight: 500;
        }

        .message-to {
            color: var(--success);
        }

        .message-time {
            color: var(--text-secondary);
        }

        .message-content {
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        /* Êó∂Èó¥Á∫ø */
        .timeline {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .timeline-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .timeline-btn:hover {
            background: var(--accent);
        }

        .timeline-progress {
            width: 200px;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            cursor: pointer;
        }

        .timeline-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #ec4899);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s;
        }

        .timeline-time {
            font-size: 13px;
            color: var(--text-secondary);
            min-width: 80px;
        }

        /* Ê∑ªÂä† Agent ÊåâÈíÆ */
        .add-agent-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .add-agent-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Âä®Áîª */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes flow {
            0% { stroke-dashoffset: 20; }
            100% { stroke-dashoffset: 0; }
        }

        .flowing {
            stroke-dasharray: 10, 10;
            animation: flow 1s linear infinite;
        }

        /* API Key Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .api-provider {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .provider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .provider-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .provider-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .provider-status.active {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .provider-status.inactive {
            background: var(--waiting);
        }

        .api-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 13px;
            font-family: monospace;
        }

        .api-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .api-input::placeholder {
            color: var(--text-secondary);
        }

        .provider-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .api-key-list {
            margin-top: 12px;
        }

        .api-key-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .api-key-name {
            color: var(--text-secondary);
        }

        .api-key-preview {
            font-family: monospace;
            color: var(--text-secondary);
        }

        .api-key-delete {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
        }

        .empty-keys {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- È°∂ÈÉ®ÊéßÂà∂Ê†è -->
    <header class="control-bar">
        <h1>ü§ñ Agent Visualizer</h1>
        <div class="controls">
            <button class="btn btn-secondary" onclick="exportPNG()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                ÂØºÂá∫ PNG
            </button>
            <button class="btn btn-secondary" onclick="exportJSON()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                ÂØºÂá∫ JSON
            </button>
            <button class="btn btn-primary" onclick="toggle3DView()" id="viewToggle">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                3D ËßÜÂõæ
            </button>
            <button class="btn btn-secondary" onclick="openApiKeysModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                </svg>
                API ÂØÜÈí•
            </button>
        </div>
    </header>

    <div class="main-container">
        <!-- Â∑¶‰æß Agent ÂàóË°® -->
        <aside class="agent-list">
            <h2>Agent ÂàóË°®</h2>
            <div id="agentList"></div>
            <button class="add-agent-btn" onclick="addNewAgent()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:8px">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Ê∑ªÂä† Agent
            </button>
        </aside>

        <!-- ‰∏≠Èó¥ÂèØËßÜÂåñÂå∫Âüü -->
        <main class="visualization" id="visualization">
            <canvas id="threeCanvas" style="display:none; width:100%; height:100%;"></canvas>
            <svg id="flowCanvas" width="100%" height="100%">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#8b5cf6"/>
                    </marker>
                    <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <g id="connections"></g>
                <g id="nodes"></g>
            </svg>
            <div class="empty-state" id="emptyState">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="3"/>
                    <circle cx="4" cy="6" r="2"/>
                    <circle cx="20" cy="6" r="2"/>
                    <circle cx="4" cy="18" r="2"/>
                    <circle cx="20" cy="18" r="2"/>
                    <line x1="6" y1="6" x2="9" y2="10"/>
                    <line x1="18" y1="6" x2="15" y2="10"/>
                    <line x1="6" y1="18" x2="9" y2="14"/>
                    <line x1="18" y1="18" x2="15" y2="14"/>
                </svg>
                <p>ÁÇπÂáª"Ê∑ªÂä† Agent"ÂºÄÂßãÂàõÂª∫Â∑•‰ΩúÊµÅÁ®ã</p>
            </div>
            <div class="view-hint" id="viewHint">
                üñ±Ô∏è ÊãñÊãΩÊóãËΩ¨ | ÊªöËΩÆÁº©Êîæ | Âè≥ÈîÆÂπ≥Áßª
            </div>
            <!-- Êó∂Èó¥Á∫ø -->
            <div class="timeline">
                <button class="timeline-btn" onclick="skipToStart()" title="Ë∑≥Âà∞ÂºÄÂßã">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="19 20 9 12 19 4 19 20"/>
                        <line x1="5" y1="19" x2="5" y2="5" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
                <button class="timeline-btn" onclick="stepBackward()" title="‰∏ä‰∏ÄÊ≠•">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="11 19 2 12 11 5 11 19"/>
                        <polygon points="22 19 13 12 22 5 22 19"/>
                    </svg>
                </button>
                <button class="timeline-btn" id="playBtn" onclick="togglePlay()" title="Êí≠Êîæ/ÊöÇÂÅú">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" id="playIcon">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                </button>
                <button class="timeline-btn" onclick="stepForward()" title="‰∏ã‰∏ÄÊ≠•">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="13 19 22 12 13 5 13 19"/>
                        <polygon points="2 19 11 12 2 5 2 19"/>
                    </svg>
                </button>
                <button class="timeline-btn" onclick="skipToEnd()" title="Ë∑≥Âà∞ÁªìÊùü">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="5 4 15 12 5 20 5 4"/>
                        <line x1="19" y1="5" x2="19" y2="19" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
                <div class="timeline-progress" onclick="seekTimeline(event)">
                    <div class="timeline-progress-bar" id="progressBar"></div>
                </div>
                <span class="timeline-time" id="timelineTime">0:00 / 0:00</span>
            </div>
        </main>

        <!-- Âè≥‰æßËØ¶ÊÉÖÈù¢Êùø -->
        <aside class="details-panel" id="detailsPanel">
            <div class="panel-header">
                <h2>ËØ¶ÁªÜ‰ø°ÊÅØ</h2>
                <button class="close-btn" onclick="closeDetails()">√ó</button>
            </div>
            <div id="panelContent">
                <p style="color: var(--text-secondary); text-align: center; padding: 40px 0;">
                    ÈÄâÊã©‰∏Ä‰∏™ Agent Êü•ÁúãËØ¶ÊÉÖ
                </p>
            </div>
        </aside>
    </div>

    <!-- API Keys Modal -->
    <div class="modal-overlay" id="apiKeysModal">
        <div class="modal">
            <div class="modal-header">
                <h2>üîë API ÂØÜÈí•ÁÆ°ÁêÜ</h2>
                <button class="modal-close" onclick="closeApiKeysModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                    ÈÖçÁΩÆÊÇ®ÁöÑ AI ÊúçÂä° API ÂØÜÈí•ÔºåÊîØÊåÅÂ§öÁßçÊ®°ÂûãÊèê‰æõÂïÜ„ÄÇÂØÜÈí•Â≠òÂÇ®Âú®Êú¨Âú∞ÊµèËßàÂô®‰∏≠Ôºå‰∏ç‰ºöÂèëÈÄÅÂà∞‰ªª‰ΩïÊúçÂä°Âô®„ÄÇ
                </p>

                <!-- OpenAI -->
                <div class="api-provider">
                    <div class="provider-header">
                        <span class="provider-name">
                            <span class="provider-status" id="openaiStatus"></span>
                            OpenAI (GPT-4o, GPT-4o mini)
                        </span>
                    </div>
                    <input type="password" class="api-input" id="openaiKey" placeholder="sk-..." oninput="updateKeyStatus('openai')">
                    <div class="provider-actions">
                        <button class="btn btn-success btn-small" onclick="saveApiKey('openai')">‰øùÂ≠ò</button>
                        <button class="btn btn-secondary btn-small" onclick="testApiKey('openai')">ÊµãËØï</button>
                    </div>
                    <div class="api-key-list" id="openaiKeysList"></div>
                </div>

                <!-- Anthropic -->
                <div class="api-provider">
                    <div class="provider-header">
                        <span class="provider-name">
                            <span class="provider-status" id="anthropicStatus"></span>
                            Anthropic (Claude)
                        </span>
                    </div>
                    <input type="password" class="api-input" id="anthropicKey" placeholder="sk-ant-..." oninput="updateKeyStatus('anthropic')">
                    <div class="provider-actions">
                        <button class="btn btn-success btn-small" onclick="saveApiKey('anthropic')">‰øùÂ≠ò</button>
                        <button class="btn btn-secondary btn-small" onclick="testApiKey('anthropic')">ÊµãËØï</button>
                    </div>
                    <div class="api-key-list" id="anthropicKeysList"></div>
                </div>

                <!-- Google -->
                <div class="api-provider">
                    <div class="provider-header">
                        <span class="provider-name">
                            <span class="provider-status" id="googleStatus"></span>
                            Google (Gemini)
                        </span>
                    </div>
                    <input type="password" class="api-input" id="googleKey" placeholder="AIza..." oninput="updateKeyStatus('google')">
                    <div class="provider-actions">
                        <button class="btn btn-success btn-small" onclick="saveApiKey('google')">‰øùÂ≠ò</button>
                        <button class="btn btn-secondary btn-small" onclick="testApiKey('google')">ÊµãËØï</button>
                    </div>
                    <div class="api-key-list" id="googleKeysList"></div>
                </div>

                <!-- Ollama -->
                <div class="api-provider">
                    <div class="provider-header">
                        <span class="provider-name">
                            <span class="provider-status" id="ollamaStatus"></span>
                            Ollama (Êú¨Âú∞Ê®°Âûã)
                        </span>
                    </div>
                    <input type="text" class="api-input" id="ollamaUrl" placeholder="http://localhost:11434" value="http://localhost:11434" oninput="updateKeyStatus('ollama')">
                    <div class="provider-actions">
                        <button class="btn btn-success btn-small" onclick="saveApiKey('ollama')">‰øùÂ≠ò</button>
                        <button class="btn btn-secondary btn-small" onclick="testApiKey('ollama')">ÊµãËØï</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeApiKeysModal()">ÂÖ≥Èó≠</button>
                <button class="btn btn-primary" onclick="exportKeys()">ÂØºÂá∫ÂØÜÈí•</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
        <script>
        // Three.js 3D Âú∫ÊôØÂèòÈáè
        let scene, camera, renderer, controls;
        let agentMeshes = [];
        let messageParticles = [];
        let is3DMode = false;
        let animationClock;

        // Agent Êï∞ÊçÆ
        let agents = [];
        let messages = [];
        let selectedAgent = null;
        let isPlaying = false;
        let currentTime = 0;
        let animationId = null;

        // Agent ËßíËâ≤ÈÖçÁΩÆ
        const agentRoles = {
            'CEO': { icon: 'üëî', color: '#8b5cf6', role: 'ÂÜ≥Á≠ñËÄÖ' },
            'CTO': { icon: 'üíª', color: '#3b82f6', role: 'ÊäÄÊúØ‰∏ªÁÆ°' },
            'Researcher': { icon: 'üîç', color: '#10b981', role: 'Á†îÁ©∂Âëò' },
            'Designer': { icon: 'üé®', color: '#ec4899', role: 'ËÆæËÆ°Â∏à' },
            'Developer': { icon: '‚ö°', color: '#f59e0b', role: 'ÂºÄÂèëËÄÖ' },
            'QA': { icon: 'üß™', color: '#06b6d4', role: 'ÊµãËØïÂ∑•Á®ãÂ∏à' },
            'Marketing': { icon: 'üì¢', color: '#ef4444', role: 'Â∏ÇÂú∫ÊÄªÁõë' },
            'Sales': { icon: 'üí∞', color: '#84cc16', role: 'ÈîÄÂîÆÊÄªÁõë' }
        };

        // ÂàùÂßãÂåñÁ§∫‰æãÊï∞ÊçÆ
        function initDemo() {
            agents = [
                { id: 1, name: 'Bezos', role: 'CEO', status: 'running', x: 400, y: 300 },
                { id: 2, name: 'Vogels', role: 'CTO', status: 'waiting', x: 200, y: 150 },
                { id: 3, name: 'Thompson', role: 'Researcher', status: 'completed', x: 200, y: 450 },
                { id: 4, name: 'Duarte', role: 'Designer', status: 'waiting', x: 600, y: 150 },
                { id: 5, name: 'Bach', role: 'QA', status: 'waiting', x: 600, y: 450 }
            ];

            messages = [
                { from: 1, to: 2, content: 'ÂàÜÊûêÊñ∞È°πÁõÆÊäÄÊúØÊñπÊ°à', time: '10:00' },
                { from: 1, to: 3, content: 'Ë∞ÉÁ†îÂ∏ÇÂú∫ËßÑÊ®°', time: '10:05' },
                { from: 2, to: 4, content: 'ÈúÄË¶ÅUIËÆæËÆ°Á®ø', time: '10:15' },
                { from: 3, to: 1, content: 'Â∏ÇÂú∫ËßÑÊ®°Ë∞ÉÁ†îÂÆåÊàê', time: '10:30' },
                { from: 4, to: 1, content: 'ËÆæËÆ°Á®øÂ∑≤ÂÆåÊàê', time: '10:45' },
                { from: 1, to: 5, content: 'ÂáÜÂ§áÊµãËØïËÆ°Âàí', time: '11:00' }
            ];

            renderAgents();
            renderFlow();
            updateTimeline();
        }

        // Ê∏≤Êüì Agent ÂàóË°®
        function renderAgents() {
            const list = document.getElementById('agentList');
            list.innerHTML = agents.map(agent => `
                <div class="agent-item ${selectedAgent === agent.id ? 'active' : ''}" onclick="selectAgent(${agent.id})">
                    <div class="agent-avatar" style="background: ${agentRoles[agent.role]?.color || '#6b7280'}20; color: ${agentRoles[agent.role]?.color || '#6b7280'}">
                        ${agentRoles[agent.role]?.icon || 'ü§ñ'}
                    </div>
                    <div class="agent-info">
                        <div class="agent-name">${agent.name}</div>
                        <div class="agent-role">${agentRoles[agent.role]?.role || agent.role}</div>
                    </div>
                    <div class="agent-status status-${agent.status}"></div>
                </div>
            `).join('');
        }

        // Ê∏≤ÊüìÊµÅÁ®ãÂõæ
        function renderFlow() {
            const nodesGroup = document.getElementById('nodes');
            const connectionsGroup = document.getElementById('connections');
            const emptyState = document.getElementById('emptyState');

            if (agents.length === 0) {
                emptyState.style.display = 'block';
                nodesGroup.innerHTML = '';
                connectionsGroup.innerHTML = '';
                return;
            }

            emptyState.style.display = 'none';

            // ÁªòÂà∂ËøûÁ∫ø
            connectionsGroup.innerHTML = messages.map((msg, idx) => {
                const fromAgent = agents.find(a => a.id === msg.from);
                const toAgent = agents.find(a => a.id === msg.to);
                if (!fromAgent || !toAgent) return '';

                return `
                    <line
                        x1="${fromAgent.x}" y1="${fromAgent.y}"
                        x2="${toAgent.x}" y2="${toAgent.y}"
                        stroke="url(#lineGradient)"
                        stroke-width="2"
                        marker-end="url(#arrowhead)"
                        class="flowing"
                        style="animation-delay: ${idx * 0.5}s"
                    />
                `;
            }).join('');

            // ÁªòÂà∂ËäÇÁÇπ
            nodesGroup.innerHTML = agents.map(agent => {
                const role = agentRoles[agent.role] || { color: '#6b7280', icon: 'ü§ñ' };
                return `
                    <g class="agent-node" onclick="selectAgent(${agent.id})" style="cursor: pointer">
                        <circle
                            cx="${agent.x}" cy="${agent.y}" r="35"
                            fill="${role.color}20"
                            stroke="${role.color}"
                            stroke-width="2"
                        />
                        <text x="${agent.x}" y="${agent.y - 5}" text-anchor="middle" fill="${role.color}" font-size="20">
                            ${role.icon}
                        </text>
                        <text x="${agent.x}" y="${agent.y + 18}" text-anchor="middle" fill="#f1f5f9" font-size="12" font-weight="500">
                            ${agent.name}
                        </text>
                        <circle
                            cx="${agent.x + 25}" cy="${agent.y - 25}" r="8"
                            fill="${getStatusColor(agent.status)}"
                            stroke="#1e293b"
                            stroke-width="2"
                        />
                    </g>
                `;
            }).join('');
        }

        function getStatusColor(status) {
            const colors = {
                'running': '#22c55e',
                'waiting': '#eab308',
                'completed': '#6b7280',
                'failed': '#ef4444'
            };
            return colors[status] || '#6b7280';
        }

        // ÈÄâÊã© Agent
        function selectAgent(id) {
            selectedAgent = id;
            renderAgents();
            renderDetails();
        }

        // Ê∏≤ÊüìËØ¶ÊÉÖÈù¢Êùø
        function renderDetails() {
            const panel = document.getElementById('panelContent');
            const agent = agents.find(a => a.id === selectedAgent);

            if (!agent) {
                panel.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 40px 0;">
                        ÈÄâÊã©‰∏Ä‰∏™ Agent Êü•ÁúãËØ¶ÊÉÖ
                    </p>
                `;
                return;
            }

            const role = agentRoles[agent.role] || { role: agent.role };
            const agentMessages = messages.filter(m => m.from === agent.id || m.to === agent.id);

            panel.innerHTML = `
                <div class="detail-section">
                    <h3>Âü∫Êú¨‰ø°ÊÅØ</h3>
                    <div class="detail-item">
                        <span class="detail-label">ÂêçÁß∞</span>
                        <span class="detail-value">${agent.name}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ËßíËâ≤</span>
                        <span class="detail-value">${role.role}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Áä∂ÊÄÅ</span>
                        <span class="detail-value" style="color: ${getStatusColor(agent.status)}">
                            ${getStatusText(agent.status)}
                        </span>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Ê∂àÊÅØÂéÜÂè≤ (${agentMessages.length})</h3>
                    <div class="message-list">
                        ${agentMessages.map(msg => {
                            const fromAgent = agents.find(a => a.id === msg.from);
                            const toAgent = agents.find(a => a.id === msg.to);
                            return `
                                <div class="message-item">
                                    <div class="message-header">
                                        <span>
                                            <span class="message-from">${fromAgent?.name || 'Êú™Áü•'}</span>
                                            ‚Üí
                                            <span class="message-to">${toAgent?.name || 'Êú™Áü•'}</span>
                                        </span>
                                        <span class="message-time">${msg.time}</span>
                                    </div>
                                    <div class="message-content">${msg.content}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function getStatusText(status) {
            const texts = {
                'running': 'ËøêË°å‰∏≠',
                'waiting': 'Á≠âÂæÖ‰∏≠',
                'completed': 'Â∑≤ÂÆåÊàê',
                'failed': 'Â§±Ë¥•'
            };
            return texts[status] || status;
        }

        // ÂÖ≥Èó≠ËØ¶ÊÉÖÈù¢Êùø
        function closeDetails() {
            document.getElementById('detailsPanel').classList.add('collapsed');
        }

        // Ê∑ªÂä†Êñ∞ Agent
        function addNewAgent() {
            const roles = Object.keys(agentRoles);
            const newId = Math.max(...agents.map(a => a.id), 0) + 1;
            const newRole = roles[Math.floor(Math.random() * roles.length)];
            const newAgent = {
                id: newId,
                name: `Agent ${newId}`,
                role: newRole,
                status: 'waiting',
                x: 200 + Math.random() * 400,
                y: 100 + Math.random() * 400
            };
            agents.push(newAgent);
            renderAgents();
            renderFlow();
            selectAgent(newId);
        }

        // Êó∂Èó¥Á∫øÊéßÂà∂
        function togglePlay() {
            isPlaying = !isPlaying;
            document.getElementById('playIcon').innerHTML = isPlaying
                ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>'
                : '<polygon points="5 3 19 12 5 21 5 3"/>';

            if (isPlaying) {
                animate();
            } else {
                cancelAnimationFrame(animationId);
            }
        }

        function animate() {
            if (!isPlaying) return;
            currentTime += 0.1;
            if (currentTime >= messages.length) {
                currentTime = 0;
            }
            updateTimeline();
            animationId = requestAnimationFrame(animate);
        }

        function updateTimeline() {
            const progress = (currentTime / Math.max(messages.length, 1)) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;

            const currentM = Math.floor(currentTime);
            const totalM = messages.length;
            document.getElementById('timelineTime').textContent = `${currentM}:${Math.floor((currentTime % 1) * 60).toString().padStart(2, '0')} / ${totalM}:00`;
        }

        function skipToStart() {
            currentTime = 0;
            updateTimeline();
        }

        function skipToEnd() {
            currentTime = Math.max(0, messages.length - 1);
            updateTimeline();
        }

        function stepForward() {
            currentTime = Math.min(currentTime + 1, messages.length - 1);
            updateTimeline();
        }

        function stepBackward() {
            currentTime = Math.max(currentTime - 1, 0);
            updateTimeline();
        }

        function seekTimeline(event) {
            const rect = event.target.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            currentTime = percent * Math.max(0, messages.length - 1);
            updateTimeline();
        }

        // ÂØºÂá∫ÂäüËÉΩ
        function exportPNG() {
            alert('ÂØºÂá∫ PNG ÂäüËÉΩÂºÄÂèë‰∏≠...');
        }

        function exportJSON() {
            const data = {
                agents: agents,
                messages: messages,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'agent-workflow.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ÂàùÂßãÂåñ
        initDemo();

        // ======== Three.js 3D Âú∫ÊôØÂäüËÉΩ ========

        function init3DScene() {
            const container = document.getElementById('visualization');
            const canvas = document.getElementById('threeCanvas');

            // Âú∫ÊôØ
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f172a);

            // Áõ∏Êú∫
            camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 300, 500);

            // Ê∏≤ÊüìÂô®
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // ËΩ®ÈÅìÊéßÂà∂
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 200;
            controls.maxDistance = 1000;

            // ÁÅØÂÖâ
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(100, 200, 100);
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0x8b5cf6, 0.5, 500);
            pointLight.position.set(0, 100, 0);
            scene.add(pointLight);

            // ÁΩëÊ†ºÂú∞Èù¢
            const gridHelper = new THREE.GridHelper(800, 20, 0x334155, 0x1e293b);
            scene.add(gridHelper);

            // Âä®ÁîªÊó∂Èíü
            animationClock = new THREE.Clock();

            // Á™óÂè£Â§ßÂ∞èË∞ÉÊï¥
            window.addEventListener('resize', onWindowResize);
        }

        function onWindowResize() {
            const container = document.getElementById('visualization');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function createAgentMesh(agent) {
            const role = agentRoles[agent.role] || { color: '#6b7280', icon: 'ü§ñ' };
            const color = new THREE.Color(role.color || '#6b7280');

            // Agent ‰∏ª‰Ωì - 3D ÁêÉ‰Ωì
            const geometry = new THREE.SphereGeometry(30, 32, 32);
            const material = new THREE.MeshPhongMaterial({
                color: color,
                emissive: color,
                emissiveIntensity: 0.3,
                shininess: 100
            });
            const mesh = new THREE.Mesh(geometry, material);

            // ‰ΩçÁΩÆÊò†Â∞Ñ (2D -> 3D)
            mesh.position.x = (agent.x - 400) * 0.8;
            mesh.position.y = 30;
            mesh.position.z = (agent.y - 300) * 0.8;
            mesh.userData = { agentId: agent.id };

            // ÂÖâÊôïÊïàÊûú
            const glowGeometry = new THREE.SphereGeometry(35, 32, 32);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: color,
                transparent: true,
                opacity: 0.2
            });
            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
            mesh.add(glow);

            // Áä∂ÊÄÅÊåáÁ§∫Âô®
            const statusColors = {
                'running': 0x22c55e,
                'waiting': 0xeab308,
                'completed': 0x6b7280,
                'failed': 0xef4444
            };
            const statusColor = statusColors[agent.status] || 0x6b7280;

            const statusGeometry = new THREE.RingGeometry(38, 42, 32);
            const statusMaterial = new THREE.MeshBasicMaterial({
                color: statusColor,
                transparent: true,
                opacity: 0.8,
                side: THREE.DoubleSide
            });
            const statusRing = new THREE.Mesh(statusGeometry, statusMaterial);
            statusRing.rotation.x = Math.PI / 2;
            mesh.add(statusRing);

            // Ê∑ªÂä†Âà∞Âú∫ÊôØ
            scene.add(mesh);
            agentMeshes.push(mesh);

            return mesh;
        }

        function updateAgentMeshes() {
            // Ê∏ÖÈô§ÊóßÁöÑ mesh
            agentMeshes.forEach(mesh => {
                scene.remove(mesh);
            });
            agentMeshes = [];

            // ÈáçÊñ∞ÂàõÂª∫
            agents.forEach(agent => {
                createAgentMesh(agent);
            });
        }

        function createMessageParticle(fromAgent, toAgent) {
            const from = new THREE.Vector3(
                (fromAgent.x - 400) * 0.8,
                30,
                (fromAgent.y - 300) * 0.8
            );
            const to = new THREE.Vector3(
                (toAgent.x - 400) * 0.8,
                30,
                (toAgent.y - 300) * 0.8
            );

            // ÂàõÂª∫Á≤íÂ≠ê
            const geometry = new THREE.SphereGeometry(5, 16, 16);
            const material = new THREE.MeshBasicMaterial({
                color: 0x8b5cf6,
                transparent: true,
                opacity: 0.8
            });
            const particle = new THREE.Mesh(geometry, material);

            particle.position.copy(from);
            particle.userData = {
                start: from,
                end: to,
                progress: 0,
                speed: 0.01
            };

            scene.add(particle);
            messageParticles.push(particle);

            return particle;
        }

        function updateMessageParticles() {
            // Ê∏ÖÈô§ÊóßÁöÑÁ≤íÂ≠ê
            messageParticles.forEach(p => scene.remove(p));
            messageParticles = [];

            // ÂàõÂª∫Êñ∞ÁöÑÁ≤íÂ≠ê
            messages.forEach(msg => {
                const fromAgent = agents.find(a => a.id === msg.from);
                const toAgent = agents.find(a => a.id === msg.to);
                if (fromAgent && toAgent) {
                    createMessageParticle(fromAgent, toAgent);
                }
            });
        }

        function animate3D() {
            if (!is3DMode) return;

            requestAnimationFrame(animate3D);
            controls.update();

            // Á≤íÂ≠êÂä®Áîª
            messageParticles.forEach(particle => {
                particle.userData.progress += particle.userData.speed;
                if (particle.userData.progress > 1) {
                    particle.userData.progress = 0;
                }

                const t = particle.userData.progress;
                particle.position.lerpVectors(
                    particle.userData.start,
                    particle.userData.end,
                    t
                );

                // ËÑâÂÜ≤ÊïàÊûú
                const scale = 1 + Math.sin(t * Math.PI * 4) * 0.3;
                particle.scale.set(scale, scale, scale);
            });

            // ÊóãËΩ¨ÊïàÊûú
            agentMeshes.forEach(mesh => {
                mesh.rotation.y += 0.01;
            });

            renderer.render(scene, camera);
        }

        function toggle3DView() {
            is3DMode = !is3DMode;
            const svgCanvas = document.getElementById('flowCanvas');
            const threeCanvas = document.getElementById('threeCanvas');
            const viewToggle = document.getElementById('viewToggle');

            if (is3DMode) {
                // ÂàáÊç¢Âà∞ 3D
                svgCanvas.style.display = 'none';
                threeCanvas.style.display = 'block';
                viewToggle.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="3" y1="9" x2="21" y2="9"/>
                        <line x1="9" y1="21" x2="9" y2="9"/>
                    </svg>
                    2D ËßÜÂõæ
                `;

                if (!scene) {
                    init3DScene();
                }
                updateAgentMeshes();
                updateMessageParticles();
                animate3D();

                // ÊòæÁ§∫Êìç‰ΩúÊèêÁ§∫
                const hint = document.getElementById('viewHint');
                hint.classList.add('show');
                setTimeout(() => hint.classList.remove('show'), 3000);
            } else {
                // ÂàáÊç¢Âà∞ 2D
                svgCanvas.style.display = 'block';
                threeCanvas.style.display = 'none';
                viewToggle.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    3D ËßÜÂõæ
                `;
            }
        }

        // ÂØºÂá∫Êó∂ÂêåÊ≠• 3D Êï∞ÊçÆ
        const originalExportJSON = exportJSON;
        exportJSON = function() {
            const data = {
                agents: agents,
                messages: messages,
                exportedAt: new Date().toISOString(),
                viewMode: is3DMode ? '3D' : '2D'
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'agent-workflow.json';
            a.click();
            URL.revokeObjectURL(url);
        };

        // ======== API Key Management ========

        // API Keys Â≠òÂÇ®
        let apiKeys = {
            openai: [],
            anthropic: [],
            google: [],
            ollama: []
        };

        // Âä†ËΩΩÂ≠òÂÇ®ÁöÑ API Keys
        function loadApiKeys() {
            const stored = localStorage.getItem('agentVisualizer_apiKeys');
            if (stored) {
                apiKeys = JSON.parse(stored);
            }
            updateAllKeyStatus();
            renderKeysList();
        }

        // ‰øùÂ≠ò API Keys Âà∞ localStorage
        function saveApiKeysToStorage() {
            localStorage.setItem('agentVisualizer_apiKeys', JSON.stringify(apiKeys));
        }

        // ÊâìÂºÄ API Keys Modal
        function openApiKeysModal() {
            document.getElementById('apiKeysModal').classList.add('show');
            loadApiKeys();
        }

        // ÂÖ≥Èó≠ API Keys Modal
        function closeApiKeysModal() {
            document.getElementById('apiKeysModal').classList.remove('show');
        }

        // Êõ¥Êñ∞ Key Áä∂ÊÄÅÊåáÁ§∫Âô®
        function updateKeyStatus(provider) {
            let input, statusEl;
            if (provider === 'ollama') {
                input = document.getElementById('ollamaUrl');
            } else {
                input = document.getElementById(provider + 'Key');
            }
            statusEl = document.getElementById(provider + 'Status');

            if (input && statusEl) {
                if (input.value && input.value.length > 0) {
                    statusEl.classList.add('active');
                    statusEl.classList.remove('inactive');
                } else {
                    statusEl.classList.remove('active');
                    statusEl.classList.add('inactive');
                }
            }
        }

        // Êõ¥Êñ∞ÊâÄÊúâ Key Áä∂ÊÄÅ
        function updateAllKeyStatus() {
            ['openai', 'anthropic', 'google', 'ollama'].forEach(updateKeyStatus);
        }

        // Ê∏≤ÊüìÂ∑≤‰øùÂ≠òÁöÑ Keys ÂàóË°®
        function renderKeysList() {
            ['openai', 'anthropic', 'google'].forEach(provider => {
                const listEl = document.getElementById(provider + 'KeysList');
                if (!listEl) return;

                const keys = apiKeys[provider] || [];
                if (keys.length === 0) {
                    listEl.innerHTML = '';
                    return;
                }

                listEl.innerHTML = keys.map((key, idx) => `
                    <div class="api-key-item">
                        <span class="api-key-name">${key.name || 'Key ' + (idx + 1)}</span>
                        <span class="api-key-preview">${key.key.substring(0, 8)}...${key.key.substring(key.key.length - 4)}</span>
                        <button class="api-key-delete" onclick="deleteApiKey('${provider}', ${idx})" title="Âà†Èô§">üóëÔ∏è</button>
                    </div>
                `).join('');
            });
        }

        // ‰øùÂ≠ò API Key
        function saveApiKey(provider) {
            let keyValue, keyName;

            if (provider === 'ollama') {
                keyValue = document.getElementById('ollamaUrl').value.trim();
                keyName = 'Êú¨Âú∞ÊúçÂä°';
            } else {
                keyValue = document.getElementById(provider + 'Key').value.trim();
                keyName = provider + ' Key ' + ((apiKeys[provider]?.length || 0) + 1);
            }

            if (!keyValue) {
                alert('ËØ∑ËæìÂÖ• API Key');
                return;
            }

            // Ê∑ªÂä†Âà∞ÂàóË°®
            if (!apiKeys[provider]) {
                apiKeys[provider] = [];
            }
            apiKeys[provider].push({
                key: keyValue,
                name: keyName,
                createdAt: new Date().toISOString()
            });

            saveApiKeysToStorage();
            updateKeyStatus(provider);
            renderKeysList();

            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            if (provider !== 'ollama') {
                document.getElementById(provider + 'Key').value = '';
            }

            // ÊòæÁ§∫‰øùÂ≠òÊàêÂäü
            showNotification('API Key Â∑≤‰øùÂ≠ò', 'success');
        }

        // Âà†Èô§ API Key
        function deleteApiKey(provider, index) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ API Key ÂêóÔºü')) {
                apiKeys[provider].splice(index, 1);
                saveApiKeysToStorage();
                updateKeyStatus(provider);
                renderKeysList();
                showNotification('API Key Â∑≤Âà†Èô§', 'success');
            }
        }

        // ÊµãËØï API Key
        async function testApiKey(provider) {
            let keyValue;
            if (provider === 'ollama') {
                keyValue = document.getElementById('ollamaUrl').value.trim();
            } else {
                keyValue = document.getElementById(provider + 'Key').value.trim();
            }

            if (!keyValue) {
                alert('ËØ∑ÂÖàËæìÂÖ• API Key ËøõË°åÊµãËØï');
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'ÊµãËØï‰∏≠...';
            btn.disabled = true;

            try {
                if (provider === 'openai') {
                    const response = await fetch('https://api.openai.com/v1/models', {
                        headers: { 'Authorization': 'Bearer ' + keyValue }
                    });
                    if (response.ok) {
                        showNotification('OpenAI API ËøûÊé•ÊàêÂäü!', 'success');
                    } else {
                        throw new Error('API Key Êó†Êïà');
                    }
                } else if (provider === 'anthropic') {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'x-api-key': keyValue,
                            'anthropic-version': '2023-06-01',
                            'content-type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'claude-3-haiku-20240307',
                            max_tokens: 10,
                            messages: [{ role: 'user', content: 'Hi' }]
                        })
                    });
                    if (response.ok || response.status === 400) {
                        showNotification('Anthropic API ËøûÊé•ÊàêÂäü!', 'success');
                    } else {
                        throw new Error('API Key Êó†Êïà');
                    }
                } else if (provider === 'google') {
                    const response = await fetch('https://generativelanguage.googleapis.com/v1/models?key=' + keyValue);
                    if (response.ok) {
                        showNotification('Google API ËøûÊé•ÊàêÂäü!', 'success');
                    } else {
                        throw new Error('API Key Êó†Êïà');
                    }
                } else if (provider === 'ollama') {
                    const response = await fetch(keyValue + '/api/tags');
                    if (response.ok) {
                        const data = await response.json();
                        const models = data.models?.map(m => m.name).join(', ') || 'Êó†ÂèØÁî®Ê®°Âûã';
                        showNotification('Ollama ËøûÊé•ÊàêÂäü! ÂèØÁî®Ê®°Âûã: ' + models, 'success');
                    } else {
                        throw new Error('Êó†Ê≥ïËøûÊé•Âà∞ Ollama');
                    }
                }
            } catch (error) {
                showNotification('ÊµãËØïÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // ÂØºÂá∫ÂØÜÈí•
        function exportKeys() {
            const data = {
                exportedAt: new Date().toISOString(),
                providers: {}
            };

            ['openai', 'anthropic', 'google', 'ollama'].forEach(provider => {
                data.providers[provider] = apiKeys[provider].map(k => ({
                    name: k.name,
                    key: k.key.substring(0, 4) + '****' + k.key.substring(k.key.length - 4),
                    createdAt: k.createdAt
                }));
            });

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'api-keys-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('ÂØÜÈí•Â§á‰ªΩÂ∑≤ÂØºÂá∫', 'success');
        }

        // ÊòæÁ§∫ÈÄöÁü•
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? 'var(--success)' : 'var(--error)'};
                color: white;
                border-radius: 8px;
                font-size: 14px;
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ÂàùÂßãÂåñ API Keys
        loadApiKeys();

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        document.getElementById('apiKeysModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeApiKeysModal();
            }
        });
    </script>
</body>
</html>
